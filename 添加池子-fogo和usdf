(function () {
  if (window.__autoDepositRunning) {
    console.warn('[autoDeposit] å·²åœ¨è¿è¡Œï¼Œè°ƒç”¨ window.autoDepositStop() åœæ­¢ã€‚');
    return;
  }

  // å…¨å±€çŠ¶æ€
  window.__autoDepositRunning = true;
  window.__depositCount = window.__depositCount || 0;

  // åœæ­¢å‡½æ•°
  window.autoDepositStop = function () {
    window.__autoDepositRunning = false;
    console.log('[autoDeposit] åœæ­¢è¯·æ±‚å·²å‘é€');
  };

  const log = (...args) => console.log('[autoDeposit]', ...args);

  // ç®€å•å»¶è¿Ÿ
  const delay = ms => new Promise(res => setTimeout(res, ms));

  // ç­‰å¾…å‡½æ•°ï¼ˆå¸¦åœæ­¢æ£€æŸ¥ï¼‰
  function waitFor(fn, { interval = 300, timeout = 30000, description = '' } = {}) {
    const start = Date.now();
    return new Promise((resolve, reject) => {
      (async function poll() {
        if (!window.__autoDepositRunning) return reject(new Error('stopped-by-user'));
        try {
          const r = fn();
          if (r) return resolve(r);
        } catch (e) {}
        if (Date.now() - start >= timeout) return reject(new Error('timeout waiting for ' + description));
        await delay(interval);
        poll();
      })();
    });
  }

  // ç‚¹å‡»å…ƒç´ ï¼ˆå°½é‡è§¦å‘ React äº‹ä»¶ï¼‰
  function clickEl(el) {
    if (!el) return;
    try {
      el.scrollIntoView({ block: 'center', inline: 'center' });
    } catch (e) {}
    ['mouseover', 'mousedown', 'mouseup', 'click'].forEach(type =>
      el.dispatchEvent(new MouseEvent(type, { bubbles: true, cancelable: true, view: window }))
    );
    // fallback native click
    try { el.click && el.click(); } catch (e) {}
    log('clicked:', (el.innerText || el.value || el.className || el.tagName).toString().slice(0, 120));
  }

  // æ‰¾åˆ°ç›®æ ‡è¾“å…¥æ¡†ï¼ˆå°½é‡ç”¨ placeholder + inputmodeï¼‰
  function findAmountInput() {
    return document.querySelector('input[placeholder="0.00"][inputmode="decimal"], input[placeholder="0.00"]');
  }

  // å¼ºç¨³å†™å…¥é‡‘é¢ï¼šå¤šç­–ç•¥ï¼ˆnative setter + inputEvent + char-by-charï¼‰
  async function setAmountRobust(input, val = '0.001') {
    if (!input) return;
    input.focus && input.focus();

    const nativeSetter = Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype, 'value').set;

    // 1) æ¸…ç©º
    try {
      nativeSetter.call(input, '');
    } catch (e) {
      input.value = '';
    }
    input.dispatchEvent(new Event('input', { bubbles: true }));
    input.dispatchEvent(new Event('change', { bubbles: true }));
    await delay(120);

    // 2) ç›´æ¥ä¸€æ¬¡æ€§å†™å…¥å¹¶æ´¾å‘ InputEvent
    try {
      nativeSetter.call(input, val);
    } catch (e) {
      input.value = val;
    }
    input.dispatchEvent(new InputEvent('input', { bubbles: true, data: val, inputType: 'insertFromPaste' }));
    input.dispatchEvent(new Event('change', { bubbles: true }));
    await delay(120);

    // 3) å¦‚æœæœªç”Ÿæ•ˆï¼Œå†ç”¨é€å­—ç¬¦è¾“å…¥ï¼ˆæ›´èƒ½è§¦å‘æ¡†æ¶ç›‘å¬ï¼‰
    if ((input.value || '') !== val) {
      try { nativeSetter.call(input, ''); } catch (e) { input.value = ''; }
      for (const ch of val.split('')) {
        try {
          nativeSetter.call(input, (input.value || '') + ch);
        } catch (e) {
          input.value = (input.value || '') + ch;
        }
        input.dispatchEvent(new InputEvent('input', { bubbles: true, data: ch, inputType: 'insertText' }));
        input.dispatchEvent(new Event('change', { bubbles: true }));
        await delay(70);
      }
    }

    // ensure blur to trigger onBlur handlers
    try { input.blur && input.blur(); } catch (e) {}
    await delay(80);

    log('amount set ->', input.value);
  }

  // æ‰¾ Deposit æŒ‰é’®ï¼ˆå¯è§ä¸”å¯ç‚¹å‡»ï¼‰
  function findDepositBtn() {
    return Array.from(document.querySelectorAll('button'))
      .find(b => {
        const txt = (b.innerText || '').trim();
        if (!/deposit/i.test(txt)) return false;
        if (b.disabled) return false;
        if (b.offsetParent === null) return false;
        const st = getComputedStyle(b);
        if (st.pointerEvents === 'none' || st.visibility === 'hidden' || st.display === 'none') return false;
        return true;
      }) || null;
  }

  // å¯é€‰ï¼šå¦‚æœå‡ºç° Confirm / Approve çš„äºŒæ¬¡ç¡®è®¤æŒ‰é’®ï¼Œè‡ªåŠ¨ç‚¹å‡»
  async function clickOptionalConfirm(timeout = 3000) {
    const start = Date.now();
    while (Date.now() - start < timeout && window.__autoDepositRunning) {
      const confirmBtn = Array.from(document.querySelectorAll('button')).find(b => {
        const t = (b.innerText || '').trim().toLowerCase();
        if (!t) return false;
        return /^(confirm|approve|confirm deposit|approve deposit|confirm tx|confirm transaction|ok)$/i.test(t) || /confirm|approve/i.test(t);
      });
      if (confirmBtn && !confirmBtn.disabled && confirmBtn.offsetParent !== null) {
        clickEl(confirmBtn);
        log('Optional confirm clicked');
        return true;
      }
      await delay(200);
    }
    return false;
  }

  // æ‰¾æˆåŠŸæç¤ºï¼ˆæ–‡æœ¬åŒ…å« Deposit successful!ï¼‰
  function findDepositSuccess() {
    // ä¼˜å…ˆæŸ¥æ‰¾åŒ…å«è¯¥ç²¾ç¡®æ–‡æœ¬çš„å…ƒç´ ï¼›è‹¥æ²¡æœ‰ï¼Œå°è¯•æ›´å®½æ¾çš„åŒ¹é…
    const exact = Array.from(document.querySelectorAll('*')).find(el => (el.textContent || '').trim().includes('Deposit successful!'));
    if (exact) return exact;
    const loose = Array.from(document.querySelectorAll('*')).find(el => /deposit successful/i.test(el.textContent || ''));
    return loose || null;
  }

  // ä¸»å¾ªç¯
  (async function mainLoop() {
    log('è„šæœ¬å¯åŠ¨ â€” è°ƒç”¨ window.autoDepositStop() åœæ­¢ã€‚');
    let round = 0;

    while (window.__autoDepositRunning) {
      round++;
      log(`--- ç¬¬ ${round} è½®å¼€å§‹ ---`);

      try {
        // 1) ç­‰è¾“å…¥æ¡†å‡ºç°å¹¶å†™å…¥é‡‘é¢ï¼ˆrobustï¼‰
        const input = await waitFor(findAmountInput, { interval: 300, timeout: 10000, description: 'é‡‘é¢è¾“å…¥æ¡†' });
        await setAmountRobust(input, '0.001');
        await delay(150);

        // 2) ç­‰ Deposit æŒ‰é’®å¯ç‚¹å‡»
        const depositBtn = await waitFor(findDepositBtn, { interval: 300, timeout: 15000, description: 'DepositæŒ‰é’®' });
        clickEl(depositBtn);

        // 2.5) å¤„ç†å¯èƒ½å‡ºç°çš„äºŒæ¬¡ç¡®è®¤ï¼ˆå¯é€‰ï¼‰
        await clickOptionalConfirm(2500);

        // 3) ç­‰å¾…æˆåŠŸæç¤º
        const successEl = await waitFor(findDepositSuccess, { interval: 400, timeout: 30000, description: 'DepositæˆåŠŸæç¤º' });
        log('ğŸ‰ æˆåŠŸæç¤ºæ£€æµ‹åˆ° ->', (successEl.textContent || '').trim().slice(0, 200));

        // 4) è®¡æ•°
        window.__depositCount = (window.__depositCount || 0) + 1;
        log('ğŸ“Š å½“å‰æˆåŠŸæ¬¡æ•°:', window.__depositCount);

        // 5) æ¸…ç©ºè¾“å…¥ï¼Œä¸ºä¸‹ä¸€è½®è§¦å‘åšå‡†å¤‡
        try {
          const nativeSetter = Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype, 'value').set;
          nativeSetter.call(input, '');
        } catch (e) {
          input.value = '';
        }
        input.dispatchEvent(new Event('input', { bubbles: true }));
        input.dispatchEvent(new Event('change', { bubbles: true }));
        await delay(800);

      } catch (err) {
        if (err && err.message === 'stopped-by-user') {
          log('ç”¨æˆ·åœæ­¢è„šæœ¬');
          break;
        }
        log('âš ï¸ æœ¬è½®å‡ºé”™:', (err && err.message) || err);
        // ç­‰ä¸€ä¼šå„¿å†ç»§ç»­ä¸‹ä¸€è½®
        await delay(3000);
      }
    }

    log('ä¸»å¾ªç¯é€€å‡º');
    window.__autoDepositRunning = false;
  })();

})();
